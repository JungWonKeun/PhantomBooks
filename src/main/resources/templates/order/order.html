<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>결제 페이지</title>
  <link rel="stylesheet" href="/css/order/order.css">
  <!-- 결제 -->
  <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
  <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  <script src="/js/order/order.js" defer></script>
  <!-- 주소 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

</head>

<body>
  <header th:replace="~{common/common}"></header>
  <main class="orderMain">

    <form>
      <div>
        <label for="userName">수령인 이름:</label>
        <input type="text" id="userName" name="userName" required>
      </div>

      <div>
        <label for="userTelNo">전화번호:</label>
        <input type="tel" id="userTelNo" name="userTelNo" required pattern="[0-9]{3}-[0-9]{4}-[0-9]{4}" placeholder="010-1234-5678">
      </div>

      <!-- 기본 배송지 -->
      <div class="addressForm">
        <input type="checkbox" id="defaultAddressCheck" checked="on">
        <h4>기본 배송지</h4>

        <div class="form-floating mb-2">
          <input type="text" class="form-control" id="userZip" name="zip" readonly th:value="${defaultAddress?.zip}">
          <label for="zip">우편번호</label>
        </div>

        <div class="form-floating mb-2">
          <input type="text" class="form-control" id="userAddress" name="address" readonly th:value="${defaultAddress?.address}">
          <label for="address">주소</label>
        </div>

        <div class="form-floating mb-2">
          <input type="text" class="form-control" id="userDetailAddress" name="detailAddress" readonly th:value="${defaultAddress?.detailAddress}">
          <label for="detailAddress">상세 주소</label>
        </div>
      </div>
    </form>

    <button type="button" id="addAddressBtn" class="btn btn-primary mt-3">배송지 추가</button>
    <div id="additionalAddresses"></div>

    <h4>주문 상품 목록</h4>
    <table>
      <thead>
        <tr>
          <th></th>
          <th>상품명</th>
          <th>수량</th>
          <th>가격</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="item : ${orderItems}">
          <td>
            <img th:src="${item.bookCover != null ? item.bookCover : '/images/bookCover/default.jpg'}" alt="책이미지" class="book-cover">
          </td>
          <td th:text="${item.bookTitle}">상품명</td>
          <td th:text="${item.cartCount}">수량</td>
          <td>
            <span class="book-price" data-price="${item.bookPrice * item.cartCount}" th:text="${item.bookPrice * item.cartCount}"></span>
          </td>
        </tr>
      </tbody>
    </table>

    <h3>
      <span class="delivery-fee" data-fee="${deliveryFee}" th:text="${deliveryFee}"></span>
    </h3>
    <h3>총 결제 금액:
      <span id="totalPrice" th:text="${totalPrice + deliveryFee}"></span> 원
    </h3>

    <button onclick="requestPay()" class="paymentButton" id="paymentButton">결제하기</button>


    
    

    <script th:inline="javascript">

      function requestPay() {

        const userName = document.getElementById('userName').value;
        const userTelNo = document.getElementById('userTelNo').value;
        const userZip = document.getElementById('userZip').value;
        const userAddress = document.getElementById('userAddress').value;
        const userDetailAddress = document.getElementById('userDetailAddress').value;
        const totalPrice = parseInt(document.getElementById('totalPrice').innerText, 10);

        if (!userName || !userTelNo) {
          alert('수령인 이름과 전화번호를 입력해주세요.');
          return;
        }

        if (!userZip || !userAddress || !userDetailAddress) {
          alert('배송지를 선택해주세요.');
          return;
        }


        const memberNo = /*[[${session.loginMember?.memberNo}]]*/ 'defaultMemberNo';
        const storeId = /*[[${storeId}]]*/ 'default-store-id';
        const channelKey = /*[[${channelKey}]]*/ 'default-channel-key';
        const redirectUrl = 'http://localhost/order/afterOrder';
        const paymentId = `${memberNo}-${Date.now()}`;
        const orderNo= /*[[${orderNo}]]*/ 'defaultOrderNo';

        const orderData = {
          memberNo: memberNo,  
          totalPrice: totalPrice,
          orderCount: 1, 
          userZip: userZip,
          userAddress: userAddress,
          userDetailAddress: userDetailAddress,
          userTelNo: userTelNo,
          userName: userName,
        };

        console.log("Order Data:", orderData);


        PortOne.requestPayment(
          {
            storeId: storeId,
            channelKey: channelKey,
            paymentId: paymentId,
            orderName: '책 결제',
            totalAmount: 10, // 테스트 금액
            // 실제 결제 금액 설정: totalAmount,
            currency: 'KRW',
            payMethod: 'CARD',
            buyerName: userName,
            buyerTel: userTelNo,
            redirectUrl: redirectUrl,
          },
          function (response) {
            if (response.success) {
              console.log('결제 성공');
              alert('결제가 성공적으로 완료되었습니다.');

              console.log("Fetch request body:", JSON.stringify(orderData));

              fetch('/order/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.orderNo) {
                        location.href = `/order/afterOrder?orderNo=${data.orderNo}`;
                    } else {
                        alert('주문에 실패했습니다. 관리자에게 문의하세요.');
                    }
                })
                .catch((error) => {
                    console.error('결제 요청 중 오류:', error);
                    alert('주문 중 문제가 발생했습니다.');
                });
                
            } else {
              alert('결제에 실패하였습니다. 다시 시도해주세요.');
            }
          }
        );
      }

    </script>
    

  </main>
  <div th:replace="~{common/footer :: footer}"></div>
</body>

</html>