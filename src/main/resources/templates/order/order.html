<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>결제 페이지</title>
  <link rel="stylesheet" href="/css/order/order.css">
  <!-- 결제 -->
  <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>

  <!-- 주소 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
  <header th:replace="~{common/common}"></header>
  <main class="orderMain">

    
    <form> 
      <div>
        <label for="userName">수령인 이름:</label>
        <input type="text" id="userName" name="userName" required>
      </div>

      <div>
        <label for="userTelNo">전화번호:</label>
        <input type="tel" id="userTelNo" name="userTelNo" required pattern="[0-9]{3}-[0-9]{4}-[0-9]{4}" placeholder="010-1234-5678">
      </div>

      <!-- 기본 배송지 -->
      <div class="addressForm">
        <input type="checkbox" id="defaultAddressCheck" checked="on">
        <h4>기본 배송지</h4>

        <div class="form-floating mb-2">
          <input type="text" class="form-control" id="userZip" name="zip" readonly th:value="${defaultAddress?.zip}">
          <label for="zip">우편번호</label>
        </div>

        <div class="form-floating mb-2">
          <input type="text" class="form-control" id="userAddress" name="address" readonly th:value="${defaultAddress?.address}">
          <label for="address">주소</label>
        </div>

        <div class="form-floating mb-2">
          <input type="text" class="form-control" id="userDetailAddress" name="detailAddress" readonly th:value="${defaultAddress?.detailAddress}">
          <label for="detailAddress">상세 주소</label>
        </div>

      </div>
    </form>
    
    <button type="button" id="addAddressBtn" class="btn btn-primary mt-3">배송지 추가</button>
    <div id="additionalAddresses">
    
      <h4>주문 상품 목록</h4>
      <table>
        <thead>
          <tr>
            <th></th>
            <th>상품명</th>
            <th>수량</th>
            <th>가격</th>
          </tr>
        </thead>

        <tbody>
          <tr th:each="item : ${orderItems}">
            <td>
              <img th:src="${item.bookCover != null ? item.bookCover : '/images/bookCover/default.jpg'}" alt="책이미징"
                class="book-cover">
            </td>
            <td th:text="${item.bookTitle}">상품명</td>
            <td th:text="${item.cartCount}">수량</td>
            <td>
              <span class="book-price" data-price="${item.bookPrice * item.cartCount}"
                th:text="${item.bookPrice * item.cartCount}">
              </span>
            </td>
            <td>
            </td>
          </tr>
        </tbody>
      </table>
      <h3>
        <span class="delivery-fee" data-fee="${deliveryFee}" th:text="${deliveryFee}"></span>
      </h3>

      <h3>총 결제 금액:
        <span id="totalPrice" th:text="${totalPrice + deliveryFee}"></span> <span> 원</span>
      </h3>

      <button class="paymentButton" id="paymentButton">결제하기</button>
    </div>

    <div th:replace="~{common/footer :: footer}"></div> 

    <script th:inline="javascript">

      function generateTimestampId() {

        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        return `${year}${month}${day}${hours}${minutes}${seconds}`;
      }
    
      function requestPay() {

        const memberId = /*[[${session.loginMember?.memberId}]]*/ 'defaultUser';
        const channelKey = /*[[${channelKey}]]*/ 'default-channel-key';
        const storeId = /*[[${storeId}]]*/ 'default-store-id';
    
        const totalAmountText = document.getElementById('totalPriceElement').innerText;
        const totalAmount = parseInt(totalAmountText.replace(/[^\d]/g, ''), 10);
    
        if (!totalAmount || isNaN(totalAmount)) {
          alert('결제 금액을 확인해주세요.');
          return;
        }
    
        const paymentId = `${memberId}-${generateTimestampId()}`;
    
        PortOne.requestPayment({
          storeId: storeId,
          paymentId: paymentId,
          orderName: "테스트 결제",
          
          // 테스트
          totalAmount: 10,

          // 실제
          // totalAmount: totalAmount;
          
          currency: "KRW",
          channelKey: channelKey,
          payMethod: "CARD",
          onSuccess: function (response) {
            console.log('결제 성공:', response);
            // 결제 성공 후 서버에 저장 요청
            fetch('/order/save', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                paymentId: paymentId,
                // totalAmount: totalAmount,

                totalAmount: 10,
                orderName: "책 주문 결제",
                response: response
              })
            })
            .then((response) => response.json())
            .then((data) => {
              console.log('결제 정보 저장 성공:', data);
              window.location.href = '/afterOrder?orderId=' + data.orderNo;
            })
            .catch((err) => {
              console.error('결제 정보 저장 실패:', err);
              alert('결제는 성공했지만 주문 정보 저장에 실패했습니다.');
            });
          },
         
        });
      }
    </script>
  <script src="/js/order/order.js"></script>

  <!-- 다음 주소 API -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  
</main>
</body>

</html>