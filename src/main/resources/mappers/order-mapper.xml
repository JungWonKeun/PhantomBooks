<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="phantom.books.finalProject.order.mapper.OrderMapper">

    <resultMap id="OrderResultMap" type="OrderDto">
        <id property="orderNo" column="order_no" />
        <result property="memberNo" column="member_no" />
        <result property="authNo" column="auth_no" />
        <result property="orderDate" column="order_date" />
        <result property="orderCount" column="order_count" />
        <result property="totalPrice" column="total_price" />
        <result property="deliveryAddress" column="delivery_address" />
        <result property="receiver" column="receiver" />
    </resultMap>

    <!-- 주문 ID로 주문 정보 조회 -->
    <select id="findOrderByOrderId" parameterType="string" resultMap="OrderResultMap">
        SELECT * 
        FROM orders 
        WHERE order_no = #{orderId}
    </select>

    <!-- 주문 항목 조회 -->
    <select id="findOrderItemByBookNoAndQuantity" parameterType="map" resultType="OrderDto">
        SELECT 
            b.book_no AS bookNo,
            b.book_title AS bookTitle,
            b.book_price AS bookPrice,
            b.book_cover AS bookCover,
            #{quantity} AS quantity,
            (b.book_price * #{quantity}) AS totalPrice
        FROM book b
        WHERE b.book_no = #{bookNo}
    </select>

    <!-- 선택된 아이템으로 주문 항목 조회 -->
    <select id="getOrderItemsByIds" parameterType="map" resultMap="OrderResultMap">
        SELECT 
            b.book_no AS bookNo,
            b.book_title AS bookTitle,
            b.book_price AS bookPrice,
            b.book_cover AS bookCover,
            c.cart_count AS quantity
        FROM cart c
        JOIN book b ON c.book_no = b.book_no
        WHERE c.member_no = #{memberNo}
          AND b.book_no IN 
          <foreach item="id" collection="selectedItems" open="(" separator="," close=")">
              #{id}
          </foreach>
    </select>

    <!-- 주문 저장 -->
    <insert id="saveOrder" parameterType="OrderDto">
        INSERT INTO orders (
            order_no, member_no, order_date, order_count, total_price, delivery_address, receiver
        ) VALUES (
            #{orderNo}, #{memberNo}, NOW(), #{orderCount}, #{totalPrice}, #{deliveryAddress}, #{receiver}
        )
    </insert>
</mapper>
